# CI/CD: Build Next.js and deploy to Azure App Service on push to main
# Secret required: AZURE_CREDENTIALS (JSON: clientId, clientSecret, subscriptionId, tenantId)

name: CI/CD â€“ Deploy to Azure

on:
  push:
    branches: [main]

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  AZURE_WEBAPP_NAME: quantumbridge-website
  AZURE_RESOURCE_GROUP: rg-quantumbridge
  AZURE_LOCATION: eastus
  NODE_VERSION: "20"

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Cache Next.js build
        uses: actions/cache@v4
        with:
          path: .next/cache
          key: next-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**/*.js', '**/*.ts', '**/*.tsx', '**/*.json') }}
          restore-keys: |
            next-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js (standalone)
        run: npm run build

      - name: Prepare deploy package
        run: |
          mkdir -p deploy
          cp -r .next/standalone/. deploy/
          mkdir -p deploy/.next
          cp -r .next/static deploy/.next/static
          cp -r public deploy/public 2>/dev/null || true
          cd deploy && zip -r ../deploy.zip . && cd ..

      - name: Upload deploy artifact
        uses: actions/upload-artifact@v4
        with:
          name: deploy-${{ github.sha }}
          path: deploy.zip
          retention-days: 1

  deploy:
    name: Deploy to Azure
    runs-on: ubuntu-latest
    needs: build
    environment: production
    steps:
      - name: Download deploy artifact
        uses: actions/download-artifact@v4
        with:
          name: deploy-${{ github.sha }}

      - name: Prepare deploy.zip for Azure
        run: |
          if [ -f deploy.zip ]; then
            echo "deploy.zip ready"
          elif [ -d deploy-${{ github.sha }} ]; then
            mv deploy-${{ github.sha }}/deploy.zip ./deploy.zip
          else
            mv deploy-*/deploy.zip ./deploy.zip
          fi

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Ensure resource group and Web App exist
        run: |
          az group create --name ${{ env.AZURE_RESOURCE_GROUP }} --location ${{ env.AZURE_LOCATION }} --output none
          if ! az webapp show --name ${{ env.AZURE_WEBAPP_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --output none 2>/dev/null; then
            az appservice plan create --name plan-quantumbridge --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --sku F1 --is-linux --output none
            az webapp create --name ${{ env.AZURE_WEBAPP_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --plan plan-quantumbridge --runtime "NODE:20-lts" --output none
            az webapp config set --name ${{ env.AZURE_WEBAPP_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --startup-file "node server.js" --output none
          fi

      - name: Start Web App and wait until ready
        run: |
          az webapp start --name ${{ env.AZURE_WEBAPP_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }}
          for i in $(seq 1 24); do
            state=$(az webapp show --name ${{ env.AZURE_WEBAPP_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --query state -o tsv 2>/dev/null || echo "Unknown")
            echo "App state: $state ($i/24)"
            if [ "$state" = "Running" ]; then
              echo "Running. Waiting 20s for deployment endpoint..."
              sleep 20
              break
            fi
            [ $i -eq 24 ] && echo "Timeout; deploying anyway."
            sleep 10
          done

      - name: Deploy to Azure Web App
        run: |
          az webapp deploy --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --name ${{ env.AZURE_WEBAPP_NAME }} --src-path deploy.zip --type zip
